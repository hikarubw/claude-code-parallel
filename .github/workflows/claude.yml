name: Claude Code

on:
  # PRé–¢é€£
  pull_request_target:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
    
  # Issueé–¢é€£ (è¿½åŠ )
  issues:
    types: [opened, assigned]
  issue_comment:
    types: [created]

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼ˆIssue/PRã”ã¨ã«åˆ¶å¾¡ï¼‰
concurrency:
  group: claude-${{ github.repository }}-${{ github.event.number || github.run_id }}
  cancel-in-progress: false

jobs:
  claude:
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‡è¦–ã®æ¡ä»¶åˆ†å²ï¼ˆIssue+PRå®Œå…¨å¯¾å¿œï¼‰
    if: |
      (
        github.event_name == 'pull_request_target' &&
        (
          github.event.pull_request.head.repo.full_name == github.repository ||
          contains(github.event.pull_request.author_association, 'COLLABORATOR') ||
          contains(github.event.pull_request.author_association, 'MEMBER') ||
          contains(github.event.pull_request.author_association, 'OWNER')
        ) &&
        contains(github.event.pull_request.body, '@claude')
      ) ||
      (
        github.event_name == 'issue_comment' &&
        (
          github.event.sender.login == github.repository_owner ||
          contains(github.event.comment.author_association, 'COLLABORATOR') ||
          contains(github.event.comment.author_association, 'MEMBER') ||
          contains(github.event.comment.author_association, 'OWNER')
        ) &&
        contains(github.event.comment.body, '@claude')
      ) ||
      (
        github.event_name == 'issues' &&
        (
          github.event.sender.login == github.repository_owner ||
          contains(github.event.issue.author_association, 'COLLABORATOR') ||
          contains(github.event.issue.author_association, 'MEMBER') ||
          contains(github.event.issue.author_association, 'OWNER')
        ) &&
        (
          contains(github.event.issue.body, '@claude') ||
          contains(github.event.issue.title, '@claude')
        )
      ) ||
      (
        github.event_name == 'pull_request_review_comment' &&
        (
          github.event.sender.login == github.repository_owner ||
          contains(github.event.comment.author_association, 'COLLABORATOR') ||
          contains(github.event.comment.author_association, 'MEMBER') ||
          contains(github.event.comment.author_association, 'OWNER')
        ) &&
        contains(github.event.comment.body, '@claude')
      ) ||
      (
        github.event_name == 'pull_request_review' &&
        (
          github.event.sender.login == github.repository_owner ||
          contains(github.event.review.author_association, 'COLLABORATOR') ||
          contains(github.event.review.author_association, 'MEMBER') ||
          contains(github.event.review.author_association, 'OWNER')
        ) &&
        contains(github.event.review.body, '@claude')
      )
    
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      # ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†ï¼ˆæœ€é«˜æ¨©é™ï¼‰
      contents: write
      pull-requests: write
      issues: write
      discussions: write
      
      # ğŸ”§ é–‹ç™ºãƒ»CI/CDç®¡ç†
      actions: write
      checks: write
      statuses: write
      pages: write
      deployments: write
      
      # ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç®¡ç†
      packages: write
      security-events: write
      
      # ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†
      repository-projects: write
      metadata: read
      
      # ğŸ†” èªè¨¼ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
      id-token: write

    steps:
      - name: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã®å–å¾—
        id: context-info
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber, prNumber, headRef, baseRef, headSha, isPR = false;
            let triggerText = '';
            
            if (context.eventName === 'pull_request_target') {
              // PRä½œæˆãƒ»æ›´æ–°æ™‚
              isPR = true;
              issueNumber = context.payload.pull_request.number;
              prNumber = context.payload.pull_request.number;
              headRef = context.payload.pull_request.head.ref;
              baseRef = context.payload.pull_request.base.ref;
              headSha = context.payload.pull_request.head.sha;
              triggerText = context.payload.pull_request.body;
              
              console.log(`PR ${String.fromCharCode(35)}${prNumber}: ${baseRef} <- ${headRef} (${headSha})`);
              
            } else if (context.eventName === 'issues') {
              // Issueä½œæˆãƒ»ã‚¢ã‚µã‚¤ãƒ³æ™‚
              isPR = false;
              issueNumber = context.payload.issue.number;
              triggerText = `${context.payload.issue.title} ${context.payload.issue.body}`;
              
              console.log(`Issue ${String.fromCharCode(35)}${issueNumber} created`);
              
            } else if (context.eventName === 'issue_comment') {
              // Issue/PRã‚³ãƒ¡ãƒ³ãƒˆ
              issueNumber = context.payload.issue.number;
              triggerText = context.payload.comment.body;
              
              if (context.payload.issue.pull_request) {
                // PRã®ã‚³ãƒ¡ãƒ³ãƒˆ
                isPR = true;
                try {
                  const pr = await github.rest.pulls.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: issueNumber
                  });
                  prNumber = issueNumber;
                  headRef = pr.data.head.ref;
                  baseRef = pr.data.base.ref;
                  headSha = pr.data.head.sha;
                  
                  console.log(`PR Comment ${String.fromCharCode(35)}${prNumber}: ${baseRef} <- ${headRef}`);
                } catch (error) {
                  console.error('PRæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                  // ã‚¨ãƒ©ãƒ¼æ™‚ã¯é€šå¸¸ã®Issueã¨ã—ã¦å‡¦ç†
                  isPR = false;
                }
              } else {
                // é€šå¸¸ã®Issueã‚³ãƒ¡ãƒ³ãƒˆ
                isPR = false;
                console.log(`Issue Comment ${String.fromCharCode(35)}${issueNumber}`);
              }
              
            } else if (context.eventName === 'pull_request_review_comment' || context.eventName === 'pull_request_review') {
              // PRãƒ¬ãƒ“ãƒ¥ãƒ¼é–¢é€£
              isPR = true;
              issueNumber = context.payload.pull_request.number;
              prNumber = context.payload.pull_request.number;
              headRef = context.payload.pull_request.head.ref;
              baseRef = context.payload.pull_request.base.ref;
              headSha = context.payload.pull_request.head.sha;
              
              if (context.eventName === 'pull_request_review_comment') {
                triggerText = context.payload.comment.body;
              } else {
                triggerText = context.payload.review.body;
              }
              
              console.log(`PR Review ${String.fromCharCode(35)}${prNumber}: ${baseRef} <- ${headRef}`);
            }
            
            // å‡ºåŠ›è¨­å®š
            core.setOutput('issue-number', issueNumber);
            core.setOutput('pr-number', prNumber || '');
            core.setOutput('head-ref', headRef || '');
            core.setOutput('base-ref', baseRef || '');
            core.setOutput('head-sha', headSha || '');
            core.setOutput('is-pr', isPR);
            core.setOutput('trigger-text', triggerText);
            
            console.log(`Final Context: Issue ${String.fromCharCode(35)}${issueNumber}, isPR: ${isPR}, Event: ${context.eventName}`);

      - name: ç’°å¢ƒæ¤œè¨¼
        run: |
          echo "ğŸ” å®Ÿè¡Œç’°å¢ƒæƒ…å ±"
          echo "=================================="
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Issue Number: ${{ steps.context-info.outputs.issue-number }}"
          echo "Is PR: ${{ steps.context-info.outputs.is-pr }}"
          echo "PR Number: ${{ steps.context-info.outputs.pr-number }}"
          echo "Head Ref: ${{ steps.context-info.outputs.head-ref }}"
          echo "Base Ref: ${{ steps.context-info.outputs.base-ref }}"
          echo "Head SHA: ${{ steps.context-info.outputs.head-sha }}"
          echo "=================================="
          
          # Secretsã®å­˜åœ¨ç¢ºèª
          if [ -z "${{ secrets.CLAUDE_ACCESS_TOKEN }}" ]; then
            echo "::error::CLAUDE_ACCESS_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          
          echo "âœ… ç’°å¢ƒæ¤œè¨¼å®Œäº†"

      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          # PRã®å ´åˆã¯feature branchã‚’ã€Issueã®å ´åˆã¯default branchã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          ref: ${{ steps.context-info.outputs.head-sha || github.ref }}
          fetch-depth: ${{ steps.context-info.outputs.is-pr == 'true' && 0 || 1 }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®å–å¾— (PRå°‚ç”¨)
        if: steps.context-info.outputs.is-pr == 'true' && steps.context-info.outputs.base-ref
        run: |
          echo "ğŸ“¥ ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒå–å¾—: ${{ steps.context-info.outputs.base-ref }}"
          git fetch origin ${{ steps.context-info.outputs.base-ref }}:${{ steps.context-info.outputs.base-ref }}
          
          echo "ğŸ“‹ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          git diff --name-only origin/${{ steps.context-info.outputs.base-ref }}..HEAD || echo "å·®åˆ†å–å¾—å¤±æ•—"
          
          echo "ğŸ“Š å¤‰æ›´çµ±è¨ˆ:"
          git diff --stat origin/${{ steps.context-info.outputs.base-ref }}..HEAD || echo "çµ±è¨ˆå–å¾—å¤±æ•—"

      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®å–å¾—
        id: project-info
        run: |
          echo "ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±åé›†"
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—ã®åˆ¤å®š
          project_type="unknown"
          framework=""
          
          if [ -f "package.json" ]; then
            project_type="node"
            echo "ğŸ“¦ Node.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º"
            
            # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯æ¤œå‡º
            if grep -q "next" package.json; then
              framework="Next.js"
            elif grep -q "react" package.json; then
              framework="React"
            elif grep -q "vue" package.json; then
              framework="Vue.js"
            elif grep -q "angular" package.json; then
              framework="Angular"
            elif grep -q "express" package.json; then
              framework="Express"
            fi
          elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            project_type="python"
            framework="Python"
            echo "ğŸ Python ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º"
          elif [ -f "Cargo.toml" ]; then
            project_type="rust"
            framework="Rust"
            echo "ğŸ¦€ Rust ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º"
          elif [ -f "go.mod" ]; then
            project_type="go"
            framework="Go"
            echo "ğŸ¹ Go ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º"
          elif [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
            project_type="java"
            framework="Java"
            echo "â˜• Java ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º"
          fi
          
          echo "project-type=$project_type" >> $GITHUB_OUTPUT
          echo "framework=$framework" >> $GITHUB_OUTPUT
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¨ã‚³ãƒ¼ãƒ‰è¡Œæ•°ã®æ¦‚ç®—
          total_files=$(find . -type f -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" -o -name "*.py" -o -name "*.rs" -o -name "*.go" -o -name "*.java" | wc -l)
          echo "total-files=$total_files" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦: $framework ($total_files ãƒ•ã‚¡ã‚¤ãƒ«)"

      - name: Claude Codeå®Ÿè¡Œ
        id: claude
        uses: hikarubw/claude-code-action@oauth
        timeout-minutes: 10
        continue-on-error: true
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          # GITHUB ACTIONS (Maximum Freedom):
          allowed_tools: |
            Edit,View,Replace,Write,Create,
            BatchTool,GlobTool,GrepTool,NotebookEditCell,
            Bash(git:*),Bash(npm:*),Bash(yarn:*),Bash(python:*),
            Bash(docker:*),Bash(make:*),Bash(cargo:*),Bash(go:*),
            Bash(ls:*),Bash(cat:*),Bash(echo:*),Bash(curl:*),
            mcp__*
          disallowed_tools: |
            Bash(sudo:*),
            Bash(rm -rf /)
        env:
          # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’Claude Codeã«æ¸¡ã™
          GITHUB_CONTEXT_TYPE: ${{ steps.context-info.outputs.is-pr == 'true' && 'PR' || 'ISSUE' }}
          ISSUE_NUMBER: ${{ steps.context-info.outputs.issue-number }}
          PR_NUMBER: ${{ steps.context-info.outputs.pr-number }}
          BASE_BRANCH: ${{ steps.context-info.outputs.base-ref }}
          HEAD_BRANCH: ${{ steps.context-info.outputs.head-ref }}
          HEAD_SHA: ${{ steps.context-info.outputs.head-sha }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          TRIGGER_TEXT: ${{ steps.context-info.outputs.trigger-text }}
          PROJECT_TYPE: ${{ steps.project-info.outputs.project-type }}
          PROJECT_FRAMEWORK: ${{ steps.project-info.outputs.framework }}
          TOTAL_FILES: ${{ steps.project-info.outputs.total-files }}
          GITHUB_ACTOR: ${{ github.actor }}
          REPOSITORY_NAME: ${{ github.repository }}
          
          # ğŸ”‘ å¼·åŒ–ã•ã‚ŒãŸæ¨©é™æƒ…å ±
          CLAUDE_PERMISSIONS_LEVEL: "ENHANCED"
          REPO_ADMIN_MODE: "true"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # ğŸ“Š ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±
          REPOSITORY_OWNER: ${{ github.repository_owner }}
          REPOSITORY_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          REPOSITORY_PRIVATE: ${{ github.event.repository.private }}
          REPOSITORY_FORK: ${{ github.event.repository.fork }}
          
          # ğŸ¯ å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
          WORKFLOW_RUN_ID: ${{ github.run_id }}
          WORKFLOW_RUN_NUMBER: ${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
          REF_NAME: ${{ github.ref_name }}
          
          # ğŸ”§ åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ãƒ•ãƒ©ã‚°
          CAN_CREATE_RELEASES: "true"
          CAN_MANAGE_LABELS: "true" 
          CAN_MANAGE_MILESTONES: "true"
          CAN_MANAGE_PROJECTS: "true"
          CAN_MANAGE_WIKI: "true"
          CAN_MANAGE_PAGES: "true"
          CAN_MANAGE_DEPLOYMENTS: "true"
          CAN_MANAGE_SECURITY: "true"
          CAN_MANAGE_PACKAGES: "true"
          CAN_MANAGE_ACTIONS: "true"

      - name: é«˜åº¦ãªãƒªãƒã‚¸ãƒˆãƒªç®¡ç†å®Ÿè¡Œ
        id: advanced-management
        if: steps.claude.outcome == 'success' && steps.context-info.outputs.issue-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.context-info.outputs.issue-number }};
            const isPR = '${{ steps.context-info.outputs.is-pr }}' === 'true';
            const triggerText = '${{ steps.context-info.outputs.trigger-text }}';
            const framework = '${{ steps.project-info.outputs.framework }}';
            const hashSymbol = String.fromCharCode(35);
            
            console.log('ğŸš€ é«˜åº¦ãªãƒªãƒã‚¸ãƒˆãƒªç®¡ç†ã‚’é–‹å§‹...');
            
            const managementResults = {
              labels: [],
              milestones: [],
              projects: [],
              releases: [],
              security: [],
              wiki: [],
              pages: [],
              actions: []
            };
            
            try {
              // 1. ğŸ·ï¸ ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒ©ãƒ™ãƒ«ç®¡ç†
              console.log('ğŸ“‹ è‡ªå‹•ãƒ©ãƒ™ãƒ«ç®¡ç†ã‚’å®Ÿè¡Œä¸­...');
              
              // å¿…è¦ãªãƒ©ãƒ™ãƒ«ã‚’è‡ªå‹•ä½œæˆ
              const requiredLabels = [
                { name: 'claude-code', color: '7B68EE', description: 'Claude Code ã«ã‚ˆã£ã¦ä½œæˆã¾ãŸã¯ä¿®æ­£ã•ã‚ŒãŸé …ç›®' },
                { name: 'auto-generated', color: '00D084', description: 'è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„' },
                { name: 'security-fix', color: 'FF4444', description: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ä¿®æ­£' },
                { name: 'performance', color: 'FFA500', description: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„' },
                { name: 'technical-debt', color: '8B4513', description: 'æŠ€è¡“çš„è² å‚µã®è§£æ±º' },
                { name: 'documentation', color: '0366D6', description: 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé–¢é€£' },
                { name: 'ci-cd', color: '28A745', description: 'CI/CDæ”¹å–„' }
              ];
              
              for (const label of requiredLabels) {
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                  managementResults.labels.push(`âœ… ä½œæˆ: ${label.name}`);
                } catch (error) {
                  if (error.status === 422) {
                    managementResults.labels.push(`ğŸ“‹ æ—¢å­˜: ${label.name}`);
                  } else {
                    managementResults.labels.push(`âŒ ã‚¨ãƒ©ãƒ¼: ${label.name} - ${error.message}`);
                  }
                }
              }
              
              // é–¢é€£ãƒ©ãƒ™ãƒ«ã‚’è‡ªå‹•ã§ä»˜ä¸
              const autoLabels = ['claude-code', 'auto-generated'];
              if (triggerText.includes('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£') || triggerText.includes('security')) {
                autoLabels.push('security-fix');
              }
              if (triggerText.includes('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹') || triggerText.includes('performance')) {
                autoLabels.push('performance');
              }
              if (triggerText.includes('æŠ€è¡“çš„è² å‚µ') || triggerText.includes('technical debt')) {
                autoLabels.push('technical-debt');
              }
              if (triggerText.includes('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ') || triggerText.includes('document')) {
                autoLabels.push('documentation');
              }
              if (triggerText.includes('CI') || triggerText.includes('CD') || triggerText.includes('deploy')) {
                autoLabels.push('ci-cd');
              }
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: autoLabels
              });
              
              managementResults.labels.push(`ğŸ·ï¸ ä»˜ä¸: ${autoLabels.join(', ')}`);
              
              // 2. ğŸ¯ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è‡ªå‹•ç®¡ç†
              console.log('ğŸ¯ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†ã‚’å®Ÿè¡Œä¸­...');
              
              try {
                // ç¾åœ¨ã®å¹´æœˆã§ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’ä½œæˆ
                const now = new Date();
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const currentMilestone = `${now.getFullYear()}-${monthNames[now.getMonth()]}`;
                
                try {
                  const milestone = await github.rest.issues.createMilestone({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: currentMilestone,
                    description: `${currentMilestone} ã®ã‚¿ã‚¹ã‚¯ã¨æ”¹å–„é …ç›®`,
                    due_on: new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString()
                  });
                  managementResults.milestones.push(`âœ… ä½œæˆ: ${currentMilestone}`);
                } catch (error) {
                  if (error.status === 422) {
                    managementResults.milestones.push(`ğŸ“… æ—¢å­˜: ${currentMilestone}`);
                  } else {
                    managementResults.milestones.push(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                  }
                }
              } catch (error) {
                managementResults.milestones.push(`âŒ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
              }
              
              // 3. ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒ‰ç®¡ç†
              console.log('ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚’å®Ÿè¡Œä¸­...');
              
              try {
                // ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
                const projects = await github.rest.projects.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
                
                if (projects.data.length > 0) {
                  const project = projects.data[0];
                  managementResults.projects.push(`ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º: ${project.name}`);
                  
                  // To Doã‚«ãƒ©ãƒ ã«ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
                  const columns = await github.rest.projects.listColumns({
                    project_id: project.id
                  });
                  
                  const todoColumn = columns.data.find(col => 
                    col.name.toLowerCase().includes('todo') || 
                    col.name.toLowerCase().includes('backlog')
                  );
                  
                  if (todoColumn) {
                    await github.rest.projects.createCard({
                      column_id: todoColumn.id,
                      content_id: issueNumber,
                      content_type: 'Issue'
                    });
                    managementResults.projects.push(`ğŸ“‹ ã‚«ãƒ¼ãƒ‰è¿½åŠ : ${project.name}`);
                  }
                } else {
                  managementResults.projects.push(`â„¹ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }
              } catch (error) {
                managementResults.projects.push(`âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
              }
              
              // 4. ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œ
              console.log('ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­...');
              
              try {
                if (triggerText.includes('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£') || triggerText.includes('security') || triggerText.includes('è„†å¼±æ€§')) {
                  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã®ç¢ºèª
                  try {
                    const vulnerabilities = await github.rest.secretScanning.listAlertsForRepo({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      state: 'open'
                    });
                    
                    managementResults.security.push(`ğŸ” ã‚ªãƒ¼ãƒ—ãƒ³ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ: ${vulnerabilities.data.length}ä»¶`);
                    
                    if (vulnerabilities.data.length > 0) {
                      managementResults.security.push(`âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã®ç¢ºèªãŒå¿…è¦ã§ã™`);
                    }
                  } catch (error) {
                    managementResults.security.push(`â„¹ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆç¢ºèª: ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã¾ãŸã¯æ©Ÿèƒ½ç„¡åŠ¹`);
                  }
                } else {
                  managementResults.security.push(`â„¹ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯: ã‚¹ã‚­ãƒƒãƒ—`);
                }
              } catch (error) {
                managementResults.security.push(`âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`);
              }
              
              // 5. ğŸ“š Wikiè‡ªå‹•æ›´æ–°
              console.log('ğŸ“š Wikiç®¡ç†ã‚’å®Ÿè¡Œä¸­...');
              
              try {
                if (triggerText.includes('wiki') || triggerText.includes('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ') || triggerText.includes('document')) {
                  // Wikiãƒšãƒ¼ã‚¸ã®å­˜åœ¨ç¢ºèª
                  try {
                    const wikiPages = await github.rest.repos.get({
                      owner: context.repo.owner,
                      repo: context.repo.repo
                    });
                    
                    if (wikiPages.data.has_wiki) {
                      managementResults.wiki.push(`ğŸ“š Wikiæœ‰åŠ¹: æ›´æ–°å¯èƒ½`);
                      // å®Ÿéš›ã®Wikiæ›´æ–°ã¯Claude Codeã§å®Ÿè¡Œã•ã‚Œã‚‹
                    } else {
                      managementResults.wiki.push(`ğŸ“š Wikiç„¡åŠ¹: è¨­å®šã§æœ‰åŠ¹åŒ–ãŒå¿…è¦`);
                    }
                  } catch (error) {
                    managementResults.wiki.push(`âŒ Wikiç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
                  }
                } else {
                  managementResults.wiki.push(`â„¹ï¸ Wikiæ›´æ–°: ã‚¹ã‚­ãƒƒãƒ—`);
                }
              } catch (error) {
                managementResults.wiki.push(`âŒ Wikiç®¡ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
              }
              
              // 6. ğŸŒ GitHub Pagesç®¡ç†
              console.log('ğŸŒ GitHub Pagesç®¡ç†ã‚’å®Ÿè¡Œä¸­...');
              
              try {
                if (triggerText.includes('pages') || triggerText.includes('deploy') || triggerText.includes('ã‚µã‚¤ãƒˆ')) {
                  try {
                    const pages = await github.rest.repos.getPages({
                      owner: context.repo.owner,
                      repo: context.repo.repo
                    });
                    
                    managementResults.pages.push(`ğŸŒ Pagesæœ‰åŠ¹: ${pages.data.html_url}`);
                    
                    // Pages build ã®å®Ÿè¡Œ
                    await github.rest.repos.requestPagesBuild({
                      owner: context.repo.owner,
                      repo: context.repo.repo
                    });
                    
                    managementResults.pages.push(`ğŸ”„ Pages rebuildå®Ÿè¡Œ`);
                  } catch (error) {
                    if (error.status === 404) {
                      managementResults.pages.push(`ğŸŒ Pagesç„¡åŠ¹: è¨­å®šã§æœ‰åŠ¹åŒ–ãŒå¿…è¦`);
                    } else {
                      managementResults.pages.push(`âŒ Pagesç®¡ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    }
                  }
                } else {
                  managementResults.pages.push(`â„¹ï¸ Pagesç®¡ç†: ã‚¹ã‚­ãƒƒãƒ—`);
                }
              } catch (error) {
                managementResults.pages.push(`âŒ Pagesç®¡ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
              }
              
              // 7. âš™ï¸ Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†
              console.log('âš™ï¸ Actionsç®¡ç†ã‚’å®Ÿè¡Œä¸­...');
              
              try {
                if (triggerText.includes('workflow') || triggerText.includes('action') || triggerText.includes('CI') || triggerText.includes('CD')) {
                  const workflows = await github.rest.actions.listRepoWorkflows({
                    owner: context.repo.owner,
                    repo: context.repo.repo
                  });
                  
                  managementResults.actions.push(`âš™ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ•°: ${workflows.data.total_count}`);
                  
                  // ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç¢ºèª
                  const disabledWorkflows = workflows.data.workflows.filter(w => w.state === 'disabled_manually');
                  if (disabledWorkflows.length > 0) {
                    managementResults.actions.push(`âš ï¸ ç„¡åŠ¹åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${disabledWorkflows.length}ä»¶`);
                  }
                } else {
                  managementResults.actions.push(`â„¹ï¸ Actionsç®¡ç†: ã‚¹ã‚­ãƒƒãƒ—`);
                }
              } catch (error) {
                managementResults.actions.push(`âŒ Actionsç®¡ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
              }
              
              console.log('âœ… é«˜åº¦ãªãƒªãƒã‚¸ãƒˆãƒªç®¡ç†å®Œäº†');
              
              // çµæœã‚’å‡ºåŠ›ã«ä¿å­˜
              core.setOutput('management-results', JSON.stringify(managementResults));
              core.setOutput('management-success', 'true');
              
            } catch (error) {
              console.error('âŒ é«˜åº¦ãªãƒªãƒã‚¸ãƒˆãƒªç®¡ç†ã‚¨ãƒ©ãƒ¼:', error);
              core.setOutput('management-error', error.message);
              core.setOutput('management-success', 'false');
            }
        id: check-changes
        if: steps.claude.outcome == 'success' && steps.context-info.outputs.is-pr == 'false'
        run: |
          echo "ğŸ” Claude Codeå®Ÿè¡Œå¾Œã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯"
          
          # Git è¨­å®š
          git config --global user.name "Claude Code Bot"
          git config --global user.email "claude-code-bot@github.com"
          
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if git diff --quiet && git diff --cached --quiet; then
            echo "å¤‰æ›´ãªã—: ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "å¤‰æ›´æ¤œå‡º: ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‚’å®Ÿè¡Œ"
            echo "has-changes=true" >> $GITHUB_OUTPUT
            
            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
            echo "ğŸ“„ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
            git diff --name-only
            git diff --cached --name-only
            
            # å¤‰æ›´çµ±è¨ˆ
            echo "ğŸ“Š å¤‰æ›´çµ±è¨ˆ:"
            git diff --stat
            git diff --cached --stat
          fi

      - name: è‡ªå‹•ãƒ–ãƒ©ãƒ³ãƒä½œæˆã¨PRä½œæˆ
        id: auto-pr
        if: steps.check-changes.outputs.has-changes == 'true' && steps.context-info.outputs.is-pr == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.context-info.outputs.issue-number }};
            const timestamp = new Date().toISOString().slice(0, 16).replace(/[-:]/g, '');
            const branchName = `claude-fix/issue-${issueNumber}-${timestamp}`;
            const defaultBranch = '${{ github.event.repository.default_branch }}';
            
            console.log(`ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒä½œæˆ: ${branchName}`);
            
            try {
              // 1. æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
              const { data: ref } = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${defaultBranch}`
              });
              
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: ref.object.sha
              });
              
              console.log(`âœ… ãƒ–ãƒ©ãƒ³ãƒä½œæˆæˆåŠŸ: ${branchName}`);
              
              // 2. å¤‰æ›´ã‚’ã“ã®ãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒŸãƒƒãƒˆ
              const { execSync } = require('child_process');
              
              // ãƒ–ãƒ©ãƒ³ãƒãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              execSync(`git checkout -b ${branchName}`, { stdio: 'inherit' });
              
              // ã™ã¹ã¦ã®å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
              execSync('git add .', { stdio: 'inherit' });
              
              // ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
              const commitMessage = `ğŸ¤– Claude Code: Issue ${String.fromCharCode(35)}${issueNumber} ã®è‡ªå‹•ä¿®æ­£

Issue ${String.fromCharCode(35)}${issueNumber} ã¸ã®å¯¾å¿œ
å®Ÿè¡Œè€…: @${{ github.actor }}`;
              
              // ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
              execSync(`git commit -m "${commitMessage}"`, { stdio: 'inherit' });
              
              // ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
              execSync(`git push origin ${branchName}`, { stdio: 'inherit' });
              
              console.log(`ğŸ“¤ ãƒ–ãƒ©ãƒ³ãƒãƒ—ãƒƒã‚·ãƒ¥å®Œäº†: ${branchName}`);
              
              // 3. Issueæƒ…å ±ã®å–å¾—
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              // 4. PRä½œæˆ
              const prTitle = `ğŸ¤– Claude Code: ${issue.title}`;
              const prBody = `## ğŸ¤– Claude Code ã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£

**é–¢é€£Issue:** ${String.fromCharCode(35)}${issueNumber}
**å®Ÿè¡Œè€…:** @${{ github.actor }}

### ğŸ“‹ å…ƒã®Issue
> ${issue.title}

### âœ… æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. å¤‰æ›´å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèª
3. å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸

**è¿½åŠ ä¿®æ­£ãŒå¿…è¦ãªå ´åˆ:** ã“ã® PR ã« \`@claude\` ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³

---
*[Claude Code Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã«ã‚ˆã‚‹è‡ªå‹•PR*`;

              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                head: branchName,
                base: defaultBranch,
                body: prBody,
                draft: false
              });
              
              console.log(`ğŸ‰ PRä½œæˆæˆåŠŸ: ${String.fromCharCode(35)}${pr.number}`);
              
              // å‡ºåŠ›è¨­å®š
              core.setOutput('pr-number', pr.number);
              core.setOutput('pr-url', pr.html_url);
              core.setOutput('branch-name', branchName);
              
              // å…ƒã®Issueã«PRä½œæˆé€šçŸ¥
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ğŸ‰ **è‡ªå‹•PRä½œæˆå®Œäº†ï¼**

**ğŸ“¥ PR:** [${String.fromCharCode(35)}${pr.number}](${pr.html_url})
**ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ:** \`${branchName}\`

PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
è¿½åŠ ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ PR ã« \`@claude\` ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚`
              });
              
            } catch (error) {
              console.error('âŒ ãƒ–ãƒ©ãƒ³ãƒãƒ»PRä½œæˆã‚¨ãƒ©ãƒ¼:', error);
              core.setOutput('error', error.message);
              
              // ã‚¨ãƒ©ãƒ¼é€šçŸ¥
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âŒ **è‡ªå‹•PRä½œæˆå¤±æ•—**

**ã‚¨ãƒ©ãƒ¼:** \`${error.message}\`

å¯¾å‡¦æ³•: æ‰‹å‹•ã§PRä½œæˆ or \`@claude\` ã§å†å®Ÿè¡Œ
è©³ç´°: [Actionså®Ÿè¡Œãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              });
            }

      - name: æˆåŠŸæ™‚ã®é€šçŸ¥
        if: steps.claude.outcome == 'success' && steps.context-info.outputs.issue-number
        uses: actions/github-script@v7
        with:
          script: |
            const isPR = '${{ steps.context-info.outputs.is-pr }}' === 'true';
            const contextType = isPR ? 'Pull Request' : 'Issue';
            const eventName = '${{ github.event_name }}';
            const framework = '${{ steps.project-info.outputs.framework }}' || 'Unknown';
            const totalFiles = '${{ steps.project-info.outputs.total-files }}' || '0';
            const hasChanges = '${{ steps.check-changes.outputs.has-changes }}' === 'true';
            const autoPrNumber = '${{ steps.auto-pr.outputs.pr-number }}';
            const autoPrUrl = '${{ steps.auto-pr.outputs.pr-url }}';
            const branchName = '${{ steps.auto-pr.outputs.branch-name }}';
            const managementSuccess = '${{ steps.advanced-management.outputs.management-success }}' === 'true';
            const managementResults = '${{ steps.advanced-management.outputs.management-results }}';
            
            const eventIcons = {
              'pull_request_target': 'ğŸ”€',
              'issue_comment': 'ğŸ’¬',
              'issues': 'ğŸ“‹',
              'pull_request_review_comment': 'ğŸ“',
              'pull_request_review': 'ğŸ‘€'
            };
            const icon = eventIcons[eventName] || 'ğŸ¤–';
            const hashSymbol = String.fromCharCode(35);
            
            let message = `${icon} **Claude Code å®Ÿè¡Œå®Œäº†**\n\n`;
            
            // è‡ªå‹•PRä½œæˆã®çµæœ
            if (!isPR && hasChanges && autoPrNumber) {
              message += `ğŸ‰ **è‡ªå‹•PRä½œæˆæˆåŠŸï¼**\n`;
              message += `- PR: [${hashSymbol}${autoPrNumber}](${autoPrUrl})\n`;
              message += `- ãƒ–ãƒ©ãƒ³ãƒ: \`${branchName}\`\n`;
              message += `- æ¬¡ã®æ‰‹é †: PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ ãƒãƒ¼ã‚¸\n\n`;
            } else if (!isPR && !hasChanges) {
              message += `â„¹ï¸ **åˆ†æã®ã¿å®Ÿè¡Œ** (ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—)\n\n`;
            }
            
            // å®Ÿè¡Œæƒ…å ±ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰
            message += `**ğŸ“Š å®Ÿè¡Œæƒ…å ±:** ${contextType} ${hashSymbol}${${{ steps.context-info.outputs.issue-number }}} | ${framework} (${totalFiles} files) | @${{ github.actor }}\n`;
            if (isPR) {
              message += `**ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ:** \`${{ steps.context-info.outputs.head-ref }}\` â†’ \`${{ steps.context-info.outputs.base-ref }}\`\n`;
            }
            
            // ãƒªãƒã‚¸ãƒˆãƒªç®¡ç†çµæœï¼ˆè¦ç´„ç‰ˆï¼‰
            if (managementSuccess && managementResults) {
              try {
                const results = JSON.parse(managementResults);
                const sections = ['labels', 'milestones', 'projects', 'security', 'wiki', 'pages', 'actions'];
                const hasResults = sections.some(s => results[s] && results[s].length > 0);
                
                if (hasResults) {
                  message += `\n**ğŸš€ è‡ªå‹•ç®¡ç†å®Ÿè¡Œ:**\n`;
                  sections.forEach(section => {
                    if (results[section] && results[section].length > 0) {
                      const summary = results[section].filter(r => r.includes('âœ…') || r.includes('âš ï¸')).slice(0, 2);
                      if (summary.length > 0) {
                        message += `${summary.map(r => `- ${r}`).join('\n')}\n`;
                      }
                    }
                  });
                }
              } catch (error) {
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯è¡¨ç¤ºã—ãªã„
              }
            }
            
            message += `\n---\n`;
            message += `ğŸ’¡ **Claude ã¸ã®æŒ‡ç¤ºä¾‹:**\n\n`;
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®ä¸»è¦ã‚³ãƒãƒ³ãƒ‰ï¼ˆç°¡æ½”ç‰ˆï¼‰
            const commands = {
              'ğŸ” åˆ†æãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼': [
                'ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™',
                'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„',
                'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ææ¡ˆã‚’ãŠé¡˜ã„ã—ã¾ã™'
              ],
              'ğŸ› ï¸ ä½œæ¥­ãƒ»å®Ÿè£…': [
                'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„',
                'ã“ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦PRã‚’ä½œæˆã—ã¦ãã ã•ã„',
                'ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ææ¡ˆã‚’ãŠé¡˜ã„ã—ã¾ã™'
              ],
              'ğŸ“š ç®¡ç†ãƒ»é‹ç”¨': [
                'ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„',
                'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„',
                'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æœ€é©åŒ–ã—ã¦ãã ã•ã„'
              ]
            };
            
            if (isPR) {
              commands['ğŸ”€ PRç‰¹æœ‰'] = [
                'ãƒãƒ¼ã‚¸å‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™',
                'ç ´å£Šçš„å¤‰æ›´ãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„'
              ];
            } else {
              commands['ğŸ“‹ Issueç‰¹æœ‰'] = [
                'ã“ã®å•é¡Œã®æ ¹æœ¬åŸå› ã‚’èª¿æŸ»ã—ã¦ãã ã•ã„',
                'è§£æ±ºç­–ã‚’è¤‡æ•°ææ¡ˆã—ã¦ãã ã•ã„'
              ];
            }
            
            Object.entries(commands).forEach(([category, cmds]) => {
              message += `**${category}:**\n`;
              cmds.forEach(cmd => message += `- \`@claude ${cmd}\`\n`);
              message += `\n`;
            });
            
            message += `ğŸ”„ **å†å®Ÿè¡Œ**: \`@claude [æŒ‡ç¤ºå†…å®¹]\` ã§ã„ã¤ã§ã‚‚å®Ÿè¡Œã§ãã¾ã™`;
            
            await github.rest.issues.createComment({
              issue_number: ${{ steps.context-info.outputs.issue-number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: å¤±æ•—æ™‚ã®é€šçŸ¥
        if: steps.claude.outcome == 'failure' && steps.context-info.outputs.issue-number
        uses: actions/github-script@v7
        with:
          script: |
            const isPR = '${{ steps.context-info.outputs.is-pr }}' === 'true';
            const contextType = isPR ? 'Pull Request' : 'Issue';
            const managementError = '${{ steps.advanced-management.outputs.management-error }}';
            const hashSymbol = String.fromCharCode(35);
            
            let message = `âŒ **Claude Code å®Ÿè¡Œå¤±æ•—**\n\n`;
            message += `${contextType} ${hashSymbol}${{ steps.context-info.outputs.issue-number }} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n`;
            
            // ã‚¨ãƒ©ãƒ¼æƒ…å ±ï¼ˆç°¡æ½”ç‰ˆï¼‰
            message += `**ğŸ“Š ã‚¨ãƒ©ãƒ¼æƒ…å ±:** ${contextType} | \`${{ github.event_name }}\` | @${{ github.actor }}\n`;
            message += `**ğŸ”— è©³ç´°ãƒ­ã‚°:** [Actionså®Ÿè¡Œãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;
            
            if (managementError) {
              message += `âš ï¸ **ãƒªãƒã‚¸ãƒˆãƒªç®¡ç†ã‚¨ãƒ©ãƒ¼:** \`${managementError}\`\n\n`;
            }
            
            // ä¸»ãªåŸå› ã¨å¯¾å‡¦æ³•ï¼ˆç®‡æ¡æ›¸ãã§ç°¡æ½”ã«ï¼‰
            message += `**ğŸ¤” è€ƒãˆã‚‰ã‚Œã‚‹åŸå› ã¨å¯¾å‡¦æ³•:**\n\n`;
            
            message += `**1. ä¸€æ™‚çš„ãªå•é¡Œ** (æœ€ã‚‚ä¸€èˆ¬çš„)\n`;
            message += `- Claude API ã®ä¸€æ™‚çš„ãªåˆ¶é™\n`;
            message += `- â†’ **å¯¾å‡¦**: 5åˆ†å¾Œã« \`@claude\` ã§å†å®Ÿè¡Œ\n\n`;
            
            message += `**2. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ** (15åˆ†åˆ¶é™)\n`;
            message += `- å‡¦ç†ãŒè¤‡é›‘ã™ãã‚‹å¯èƒ½æ€§\n`;
            message += `- â†’ **å¯¾å‡¦**: ã‚ˆã‚Šå…·ä½“çš„ãªæŒ‡ç¤ºã§åˆ†å‰²å®Ÿè¡Œ\n\n`;
            
            message += `**3. è¨­å®šã®å•é¡Œ**\n`;
            message += `- ãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸé™åˆ‡ã‚Œãƒ»è¨­å®šãƒŸã‚¹\n`;
            message += `- â†’ **å¯¾å‡¦**: Settings â†’ Secrets â†’ Actions ã§ç¢ºèª\n`;
            message += `  - \`CLAUDE_ACCESS_TOKEN\`\n`;
            message += `  - \`CLAUDE_REFRESH_TOKEN\`\n`;
            message += `  - \`CLAUDE_EXPIRES_AT\`\n\n`;
            
            // ç°¡æ½”ãªå†å®Ÿè¡Œã‚¬ã‚¤ãƒ‰
            message += `**ğŸ’¡ å†å®Ÿè¡Œã®ãƒ’ãƒ³ãƒˆ:**\n`;
            message += `- å…·ä½“çš„ã«: \`@claude src/components/Button.tsxã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼\`\n`;
            message += `- æ®µéšçš„ã«: ã¾ãš1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰\n`;
            message += `- æ˜ç¢ºã«: æœŸå¾…ã™ã‚‹çµæœã‚’ä¼ãˆã‚‹\n\n`;
            
            message += `---\n`;
            message += `ğŸ”„ **å†å®Ÿè¡Œ**: \`@claude [å…·ä½“çš„ãªæŒ‡ç¤º]\` ã§å†åº¦ãŠè©¦ã—ãã ã•ã„\n`;
            message += `ğŸ“ **ã‚µãƒãƒ¼ãƒˆ**: å•é¡ŒãŒç¶šãå ´åˆã¯ç®¡ç†è€…ã¸ã”é€£çµ¡ãã ã•ã„`;
            
            await github.rest.issues.createComment({
              issue_number: ${{ steps.context-info.outputs.issue-number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: å®Ÿè¡Œãƒ­ã‚°ã®å‡ºåŠ›
        if: always()
        run: |
          echo "ğŸ“Š ===== å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼ ====="
          echo "Status: ${{ steps.claude.outcome }}"
          echo "Context Type: ${{ steps.context-info.outputs.is-pr == 'true' && 'PR' || 'Issue' }}"
          echo "Issue/PR: '#${{ steps.context-info.outputs.issue-number }}'"
          echo "Branch: ${{ steps.context-info.outputs.head-ref || 'default' }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "Project: ${{ steps.project-info.outputs.framework || 'Unknown' }}"
          echo "Files: ${{ steps.project-info.outputs.total-files || '0' }}"
          echo "Duration: ${{ steps.claude.outputs.duration || 'N/A' }}"
          echo ""
          echo "ğŸ”§ === è‡ªå‹•PRä½œæˆçµæœ ==="
          echo "Has Changes: ${{ steps.check-changes.outputs.has-changes || 'N/A' }}"
          echo "Auto PR Number: ${{ steps.auto-pr.outputs.pr-number || 'N/A' }}"
          echo "Auto PR URL: ${{ steps.auto-pr.outputs.pr-url || 'N/A' }}"
          echo "Branch Name: ${{ steps.auto-pr.outputs.branch-name || 'N/A' }}"
          echo "Auto PR Error: ${{ steps.auto-pr.outputs.error || 'None' }}"
          echo ""
          echo "ğŸš€ === é«˜åº¦ãªãƒªãƒã‚¸ãƒˆãƒªç®¡ç†çµæœ ==="
          echo "Management Success: ${{ steps.advanced-management.outputs.management-success || 'N/A' }}"
          echo "Management Error: ${{ steps.advanced-management.outputs.management-error || 'None' }}"
          echo "Management Results Available: ${{ steps.advanced-management.outputs.management-results && 'Yes' || 'No' }}"
          echo ""
          echo "Timestamp: $(date -u)"
          echo "=============================="