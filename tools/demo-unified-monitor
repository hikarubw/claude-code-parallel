#!/bin/bash
# Demo script for unified monitoring dashboard
# Shows different monitoring capabilities

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

echo -e "${BOLD}${CYAN}Claude Code Parallel - Unified Monitor Demo${NC}"
echo "=========================================="
echo

# Function to pause and wait
pause() {
    echo
    echo -e "${YELLOW}Press any key to continue...${NC}"
    read -n 1 -s
    echo
}

# Function to show section
show_section() {
    local title="$1"
    echo -e "${BOLD}${BLUE}$title${NC}"
    echo "----------------------------------------"
}

# 1. Show available commands
show_section "1. Available Monitoring Commands"
echo "The unified monitor provides several viewing options:"
echo
echo "  unified-monitor          # Live dashboard (default)"
echo "  unified-monitor once     # Single status snapshot"
echo "  unified-monitor metrics  # Just the metrics"
echo "  unified-monitor json     # JSON output for integration"
echo "  unified-monitor debug    # Debugging information"
pause

# 2. Show status snapshot
show_section "2. Status Snapshot"
echo "Here's a single status update:"
echo
"$SCRIPT_DIR/unified-monitor" once 2>/dev/null || {
    echo -e "${YELLOW}Note: No active queue/workers. Starting demo data...${NC}"
    
    # Create some demo queue entries
    mkdir -p "$HOME/.claude/queue"
    QUEUE_FILE="$HOME/.claude/queue/queue.txt"
    COMPLETED_FILE="$HOME/.claude/queue/completed.txt"
    
    # Add demo tasks
    echo "1|123|201|pending||$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$QUEUE_FILE"
    echo "2|123|202|working|worker-1|$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$QUEUE_FILE"
    echo "3|124|203|pending||$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$QUEUE_FILE"
    echo "2|123|200|completed|worker-2|$(date -u -d '30 minutes ago' +%Y-%m-%dT%H:%M:%SZ)|$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$COMPLETED_FILE"
    
    "$SCRIPT_DIR/unified-monitor" once
}
pause

# 3. Show metrics only
show_section "3. Performance Metrics"
echo "Get just the metrics for quick checks:"
echo
"$SCRIPT_DIR/unified-monitor" metrics
pause

# 4. Show JSON output
show_section "4. JSON Output for Integration"
echo "Perfect for scripting and automation:"
echo
"$SCRIPT_DIR/unified-monitor" json | jq '.'
pause

# 5. Show project-status integration
show_section "5. Project Status Command"
echo "The /project:status command now uses unified monitoring:"
echo
echo "Examples:"
echo "  project-status              # Full status"
echo "  project-status --workers    # Just workers"
echo "  project-status --queue      # Just queue"
echo "  project-status --issues     # Parent issue progress"
echo "  project-status --watch      # Live monitoring"
echo
echo "Current worker status:"
"$SCRIPT_DIR/project-status" --workers
pause

# 6. Show different views
show_section "6. Specialized Views"
echo "Queue view:"
"$SCRIPT_DIR/project-status" --queue
echo
echo "Issue progress view:"
"$SCRIPT_DIR/project-status" --issues
pause

# 7. Live monitoring
show_section "7. Live Monitoring Dashboard"
echo "The live dashboard provides real-time updates with:"
echo
echo "  • Visual progress bars"
echo "  • Active worker status"
echo "  • Performance metrics"
echo "  • Recent activity log"
echo "  • Interactive controls (q=quit, r=refresh, w=workers, p=pueue)"
echo
echo -e "${GREEN}Try it now:${NC} unified-monitor"
echo -e "${GREEN}Or use:${NC} /project:status --watch"
echo
echo -e "${YELLOW}Demo complete!${NC}"
echo
echo "The unified monitor provides comprehensive visibility into:"
echo "  ✓ Queue depth and task distribution"
echo "  ✓ Worker health and current activities"
echo "  ✓ Completion rates and performance metrics"
echo "  ✓ Failed task tracking and debugging"
echo "  ✓ Real-time activity monitoring"

# Clean up demo data
if [[ -f "$HOME/.claude/queue/queue.txt.demo" ]]; then
    rm -f "$HOME/.claude/queue/queue.txt"
    rm -f "$HOME/.claude/queue/completed.txt"
fi